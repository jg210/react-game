name: checks

on: push

jobs:
  checks:
    runs-on: ubuntu-20.04
    permissions:
      contents: read

    steps:

    - uses: actions/checkout@v3

    - uses: actions/setup-node@v4
      with:
        node-version-file: '.node-version'

    - run: npm ci
    
    - run: npm run ci

    - name: Update tokens
      env:
        SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        GOOGLE_ANALYTICS_TRACKING_ID: ${{ secrets.GOOGLE_ANALYTICS_TRACKING_ID }}
      run: |
        sed -i "s,__SENTRY_DSN__,${SENTRY_DSN:-__SENTRY_DSN__}," src/index.js
        sed -i "s,__SENTRY_RELEASE__,react-game@${GITHUB_SHA}," src/index.js
        sed -i "s,__GOOGLE_ANALYTICS_TRACKING_ID__,${GOOGLE_ANALYTICS_TRACKING_ID:-__GOOGLE_ANALYTICS_TRACKING_ID__},g" src/util/google_analytics.js

    - run: npm run build

    - name: Upload artifact
      if: github.ref == 'refs/heads/master'
      uses: actions/upload-pages-artifact@v3.0.0
      with:
        name: react-game
        path: build

  deploy:
    needs: checks
    runs-on: ubuntu-20.04
    permissions:
      pages: write
      id-token: write
    if: github.ref == 'refs/heads/master'
    steps:
      - uses: actions/deploy-pages@v4.0.2
        with:
          artifact_name: react-game

  # TODO prevent repetition of react-game@${GITHUB_SHA}
  # TODO prevent repetition of "react-game" artifact name
  # TODO deployment
  #
  # - script: npm run sentry-cli -- releases new -p react-game "react-game@${GITHUB_SHA}" && npm run sentry-cli -- releases set-commits --auto "react-game@${GITHUB_SHA}"
  #   on:
  #     branch: master

  # - provider: script
  #   skip_cleanup: true
  #   script: npm run sentry-cli -- releases deploys "react-game@${GITHUB_SHA}" new -e production
  #   on:
  #     branch: master
